<!DOCTYPE html "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Directions Fly To</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
        <script type="text/javascript" src="../src/mapbridge.js?key=ABQIAAAAGY8Xhrw1zw6Ia3dwUJVxKRT8bemrB74QmF-ljSt0r6xw5vxKjRThb7jzwbyK9G49GGC_obt8W5UHhg">
        </script>
        <script type="text/javascript">
            
            var map;
            var dir;
            var route;
            var flying = false;
            var turnCounter = 0;
            var turning = false;
            var pointOffset = null;
            function init() {
              MapBridge.createMap(document.getElementById('map_canvas'), function(mp) {
                map = mp;//'mapevent_mappreinitialize''mapevent_mapready'
                map.addEventListener(MapEvent.MAP_PREINITIALIZE(), onMapPreinitialize);
                map.addEventListener(MapEvent.MAP_READY(), onMapReady);
                map.addEventListener(MapEvent.FLY_TO_DONE(), flyToNext);
                pointOffset = map.create('flash.geom.Point', [0, -30]);
              });
            }
            
            function onMapPreinitialize(e) {
              var myMapOptions = new MapOptions({
                zoom: 8,
                center: new LatLng(41.651505, -72.094455),
                mapType: MapType.SATELLITE_MAP_TYPE(),
                viewMode: View.VIEWMODE_PERSPECTIVE(),
                attitude: new Attitude(0, 0, 0)
              });
              map.setInitOptions(myMapOptions);
            }
            
            function onMapReady(e) {
              //map.setCenter(new LatLng(41.651505, -72.094455), 8);
              map.setCenter(new LatLng(40, -100), 4);
              map.addControl(new NavigationControl());
              map.addControl(new MapTypeControl());
              map.enableScrollWheelZoom();
              dir = new Directions();
              dir.addEventListener(DirectionsEvent.DIRECTIONS_SUCCESS(), onDirLoad);
              dir.addEventListener(DirectionsEvent.DIRECTIONS_FAILURE(), onDirFail);
              $('getDir').disabled=false;
            }
            
            function $(id) {
              return document.getElementById(id);
            }
            
            function processDirections() {
              dir.load("from: " + $('from').value + " to: " + $('to').value);
              flying = false;
              // Reset turnCounter to zero for new directions
              turning = false;
              turnCounter = 0;
              
            }
            
            function onDirFail(e) {
              alert('Status:' + e.getDirections().getStatus());
              $('step').innerHTML = '';
            }
            
            function onDirLoad(e) {
              dir = e.getDirections();
              route = dir.getRoute(0);
              var startMarker;
              var endMarker;
              
              map.clearOverlays();
              map.addOverlay(dir.createPolyline());
              map.setZoom(map.getBoundsZoomLevel(dir.getBounds()));
              
              
              startMarker = new Marker(dir.getRoute(0).getStartGeocode().getPoint(), new MarkerOptions({
                fillStyle: new FillStyle({
                  color: Color.GREEN()
                })
              }));
              endMarker = new Marker(dir.getRoute(0).getEndGeocode().getPoint(), new MarkerOptions({
                fillStyle: new FillStyle({
                  color: Color.BLUE()
                })
              }));
              map.addOverlay(startMarker);
              map.addOverlay(endMarker);
              var angle = computeAngle(endMarker.getLatLng(), startMarker.getLatLng());
              map.setCenter(startMarker.getLatLng());
              map.setAttitude(new Attitude(angle, 30, 0));
              var text = "Start at " + $('from').value;
              $('step').innerHTML = text;
              startMarker.openInfoWindow(new InfoWindowOptions({
                contentHTML: text, pointOffset:pointOffset
              }));
              $('flyTo').disabled = false;
              $('cancelFly').disabled = false;
             
            }
            
            function flyToNext() {
              if (!flying) 
                return;
              if (!turning) {
                turnCounter++;
              }
              
              totalSteps = route.getNumSteps();
              if (turnCounter <= totalSteps) {
                var step = route.getStep(turnCounter - 1);
                var latlng = step.getLatLng();
                var nextLatlng = null;
                if (turnCounter < totalSteps) {
                  nextLatlng = route.getStep(turnCounter).getLatLng();
                } else {
                  nextLatlng = route.getEndLatLng();
                }
                var stepText = "<br/>Step " + turnCounter + ": " + step.getDescriptionHtml() + ' ' + step.getDurationHtml() + ' ' + step.getDistanceHtml();
                // some logic to decide zoom and fly duration, can be improved for a smoother fly
                var d = step.getDistance();
                var z = 20-Math.floor(Math.log(d)/Math.log(4) + 0.5);
                var dr = step.getDuration();
                var ep = Math.exp(Math.log(dr)/Math.log(10))/3;
                var angle = computeAngle(nextLatlng, latlng);
                var a = map.getAttitude();
                if (angle - a.getYaw()>180){
                  // avoid turning in wrong clockwise.
                  angle -=360;
                }
                if (a.getYaw() - angle > 180) {
                  angle +=360;
                }
                //stepText+='('+angle+')('+ a.getYaw()+')';
                if (!turning) {
                  map.openInfoWindow(latlng, new InfoWindowOptions({
                    contentHTML: stepText,
                     pointOffset: pointOffset
                  }));
                  $('step').innerHTML += stepText;
                  turning = true;
                  map.flyTo(latlng, z, new Attitude(angle, a.getPitch(), a.getRoll()), 2);
                  return;
                } else {
                  turning = false;
                  // let's go!
                  var stepMarker = new Marker(nextLatlng, new MarkerOptions({
                    label: turnCounter.toString()
                  }));
                  map.addOverlay(stepMarker);
                  map.flyTo(nextLatlng, z, new Attitude(angle, a.getPitch(), a.getRoll()), ep);
                }
              } else {
                flying = false;
                $('flyTo').disabled = true;
                 $('cancelFly').disabled = true;
                var text = "<br/>Arrive at " + $('to').value + " : " + route.getSummaryHtml();
                map.openInfoWindow(route.getEndLatLng(), new InfoWindowOptions({
                  contentHTML: text,
                  pointOffset: pointOffset
                }));
                $('step').innerHTML += text;
               
              }
            }
            
            //http://gmaps-samples.googlecode.com/svn/trunk/streetview/angletowardsbuilding.html
            function computeAngle(endLatLng, startLatLng) {
              var DEGREE_PER_RADIAN = 57.2957795;
              var RADIAN_PER_DEGREE = 0.017453;
            
              var dlat = endLatLng.lat() - startLatLng.lat();
              var dlng = endLatLng.lng() - startLatLng.lng();
              // We multiply dlng with cos(endLat), since the two points are very closeby,
              // so we assume their cos values are approximately equal.
              var yaw = Math.atan2(dlng * Math.cos(endLatLng.lat() * RADIAN_PER_DEGREE), dlat) *
              DEGREE_PER_RADIAN;
              return wrapAngle(yaw);
            }
            
            function wrapAngle(angle) {
              if (angle >= 360) {
                angle -= 360;
              } else if (angle < 0) {
                angle += 360;
              }
              return angle;
            }
        </script>
    </head>
    <body onload="init()">
        <form>
            <div>
            From: <input type="text" id="from" value="Boston, MA" size="30"/>To: <input type="text" id="to" value="New York, NY" size="30"/><input type="button" id="getDir" onclick="processDirections()" disabled="true" value="Get Directions"/>
            <input id="flyTo" type="button" onclick="flying = true; flyToNext();" value="Fly To" disabled="true"/>
           <input id="cancelFly" type="button" onclick="flying = false; map.cancelFlyTo();" value="Cancel Fly" disabled="true"/>
        </form>
        <table width="100%">
            <tr>
                <td width="400" valign="top">
                    <div id="step" style="width:100%;height:500px; overflow:auto">
                    </div>
                </td>
                <td width="500" valign="top">
                    <div id="map_canvas" style="width:100%;height:500px">
                    </div>
                </td>
            </tr>
        </table>
    </body>
</html>
