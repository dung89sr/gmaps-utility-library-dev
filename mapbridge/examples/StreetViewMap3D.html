<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <style>
            body {
                margin: 0px;
                overflow: hidden
            }
        </style>
        <script type="text/javascript" src="../src/mapbridge_packed.js?key=ABQIAAAAGY8Xhrw1zw6Ia3dwUJVxKRTVDgad4Bvurg1SD7pTTN986X-SXRSKKVrETJW4qaW12HAV5dyl6wH7sw">
        </script>
        <script type="text/javascript" src="http://maps.google.com/maps?file=api&amp;&v=2&key=ABQIAAAAGY8Xhrw1zw6Ia3dwUJVxKRTVDgad4Bvurg1SD7pTTN986X-SXRSKKVrETJW4qaW12HAV5dyl6wH7sw">
        </script>
        <script type="text/javascript">
            var map;
            var pano;
            var master = null; //'map|pano'
            var pitchScale = 2;//||2
            var marker;
            function init() {
              MapBridge.createMap(document.getElementById('map_canvas'), function(mp) {
                map = mp;
                map.addEventListener('mapevent_mappreinitialize', onMapPreinitialize);
                map.addEventListener('mapevent_mapready', onMapReady);
              });
            }
            
            function onMapPreinitialize(e) {
              var p = new LatLng(35, -80);
              map.setInitOptions(new MapOptions({
                viewMode: View.VIEWMODE_PERSPECTIVE(),
                zoom: 18,
                center: new LatLng(35.2272, -80.8431),
                attitude: new Attitude(50, 40, 0)
              }));
            }
            
            function onMapReady(e) {
              map.enableContinuousZoom();
              map.enableScrollWheelZoom();
              map.addControl(new NavigationControl());
              map.addControl(new MapTypeControl());
              marker = new Marker(map.getCenter(), new MarkerOptions({
                draggable: true
              }));
              map.addOverlay(marker);
              map.addEventListener('mapevent_attitudechangeend', syncPanoToMap);
              map.addEventListener('mapevent_attitudechangestep', syncPanoToMap);
              map.addEventListener('mapevent_moveend', syncPanoToMap);
              map.addEventListener('mapevent_rollover', function(e) {
                master = 'map';
                document.getElementById('msg').innerHTML = master;
              });
              marker.addEventListener('mapevent_overlaymoved', syncPanoToMap);
              initPano();
            }
            
            function initPano() {
              var c = map.getCenter();
              var a = map.getAttitude();
              var pnode = document.getElementById('pano_canvas');
              pano = new GStreetviewPanorama(pnode, {
                latlng: new GLatLng(c.lat(), c.lng()),
                pov: {
                  yaw: a.getYaw(),
                  pitch: getPanoPitch(a.getPitch())
                }
              });
              GEvent.addListener(pano, 'error', function(errCode) {
                if (errCode == 600) {
                  //alert('NO_NEARBY_PANO');
                } else if (errCode == 603) {
                  alert('FLASH_UNAVAILABLE');
                }
              });
              GEvent.addListener(pano, 'yawchanged', syncMapToPano);
              GEvent.addListener(pano, 'pitchchanged', syncMapToPano);
              GEvent.addListener(pano, 'initialized', syncMapToPano);
              GEvent.addDomListener(pnode, 'mouseover', setPanoAsMaster);
              GEvent.addDomListener(pnode, 'mousemove', setPanoAsMaster);
              
            }
            
            function setPanoAsMaster(e) {
              master = 'pano';
              document.getElementById('msg').innerHTML = master;
            }
            
            
            function syncMapToPano(e) {
              master = master || 'pano';
              var c = null;
              if (e && e.latlng) {
                // regardless who is master, marker should be adjusted
                c = new LatLng(e.latlng.lat(), e.latlng.lng());
                marker.setLatLng(c);
                if (driving) {
                  pano.followLink(e.pov.yaw);
                }
              }
              if (master == 'pano') {
                var a = map.getAttitude();
                var pov;
                
                var pitch = a.getPitch();
                if (e && e.latlng) {
                  pov = e.pov;
                } else {
                  pov = pano.getPOV();
                }
                if (c) {
                  map.setCenter(c);
                }
                if (pov.pitch != undefined) {// initialized event does not carry pitch
                  pitch = getMapPitch(pov.pitch);
                }
                map.setAttitude(new Attitude(pov.yaw, pitch, a.getRoll()));
              }
            }
            
            function syncPanoToMap(e) {
              master = master || 'map';
              if (master == 'map') {
                var a = map.getAttitude();
                if (e) {
                  var f = e.getFeature();
                  if (!f) {
                    marker.setLatLng(map.getCenter());
                  }
                }
                var c = marker.getLatLng();
                pano.setLocationAndPOV(new GLatLng(c.lat(), c.lng()), {
                  yaw: a.getYaw(),
                  pitch: getPanoPitch(a.getPitch())
                });
              }
            }
            
            function getMapPitch(ppitch) {
              if (pitchScale == 1) {
                return Math.min(85, Math.max(0, 90 - ppitch));
              } else {
                var t = Math.min(85, Math.max(-85, ppitch));
                return (85 - t) / 2;
              }
              
            }
            
            function getPanoPitch(mpitch) {
              if (pitchScale == 1) {
                return 90 - mpitch;
              } else {
                return 85 - mpitch * 2;
              }
            }
            
            function setPitchScale(s) {
              pitchScale = s;
              if (master == 'map') {
                syncPanoToMap();
              } else if (master == 'pano') {
                syncMapToPano();
              }
            }
            
            function log(msg) {
              GLog.write(msg);
            }
        </script>
    </head>
    <body onload="init()">
        <h4>Synchronized Map3D and StreetView. </h4>
        <div>
            Move map or street view, or drag marker, the other component will sync. 
            <br/>
            Because map pitch value range is 0 to 85, street view pitch  -90 to 90, you can choose whether to scale the angles to the similar range.
            <br/>
            Pitch Angle Scaling: <input type="radio" name="pitchMode" value="1" onclick="setPitchScale(1);">No pitch angle scaling.<input type="radio" name="pitchMode" value="2" checked="checked" onclick="setPitchScale(2);">scale angles. 
        </div>
        <table border="2">
            <tr>
                <td>
                    <div id="map_canvas" style="width:500px;height:600px">
                    </div>
                </td>
                <td>
                    <div id="pano_canvas" style="width:500px;height:600px">
                    </div>
                </td>
            </tr>
        </table>
        <div id="msg">
        </div>
    </body>
</html>
